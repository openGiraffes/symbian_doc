
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Mirrored from devlib.symbian.slions.net/belle/GUID-AA978F65-C25B-59DC-82BC-6892228EA3F9.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 04:02:56 GMT -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="copyright" content="(C) Copyright 2012" /><meta name="DC.rights.owner" content="(C) Copyright 2012" /><meta name="DC.Type" content="concept" /><meta name="DC.Title" content="Schedule Send Tutorial" /><meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7" /><meta name="DC.Relation" scheme="URI" content="GUID-5DD1010C-1648-5086-BA80-BC25F3C7A2C4" /><meta name="DC.Relation" scheme="URI" content="GUID-C290FA5E-8E41-5D19-B8C1-F88491EE6388" /><meta name="DC.Relation" scheme="URI" content="GUID-CADAABB4-C957-502E-BA4D-E9614C0D3878" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="GUID-AA978F65-C25B-59DC-82BC-6892228EA3F9" /><meta name="DC.Language" content="en" /><title>Schedule Send Tutorial </title><link href="css/s60/style.css" rel="stylesheet" type="text/css" /><link href="PLUGINS_ROOT/com.nokia.forum.library/css/category_cpp5.html" rel="stylesheet" type="text/css" /></head><body><div class="body"><div class="contentLeft prTxt"><h1 class="pageHeading" id="GUID-AA978F65-C25B-59DC-82BC-6892228EA3F9">Schedule Send Tutorial</h1><div>
<p>Schedule Send MTM (Message Type Module) allows other MTMs to send
messages at scheduled times. </p>
<p>This tutorial describes how to schedule SMS sending. </p>
<p>For instructions on sending
SMS messages, see <a href="GUID-33B590F4-CAE8-58B2-92A9-53123BD42579.html">SMS Tutorial</a>.</p>
<div id="GUID-0085E819-D7D7-4630-90E9-92C5C643CC39"><h3 class="section-title">Required
background</h3> <p>Before you start, you must understand: </p> <ul>
<li id="GUID-E818F9A1-74F9-56A2-ADE6-421E3CEFA625"><a name="GUID-E818F9A1-74F9-56A2-ADE6-421E3CEFA625"><!-- --></a><p><a href="GUID-33C7EEEB-88B8-5587-916D-2C5D122F6010.html">SMS MTM</a> </p> </li>
</ul> </div>
<div id="GUID-6777CD54-DBF2-420C-9EEC-B4AA91AACB04"><h3 class="section-title">Introduction</h3> <p>Scheduled Send MTM enables you to do the following tasks: </p> <ul>
<li id="GUID-7BE42BD7-E4BC-586E-987F-2F7AD54EB1AC"><a name="GUID-7BE42BD7-E4BC-586E-987F-2F7AD54EB1AC"><!-- --></a><p>Schedule a message
to be sent at a specific scheduled time. </p> </li>
<li id="GUID-E05C56E1-5AB2-50E8-ADD1-F5FEFDA48A3A"><a name="GUID-E05C56E1-5AB2-50E8-ADD1-F5FEFDA48A3A"><!-- --></a><p>Check whether
specified conditions are met before sending a message. </p> </li>
<li id="GUID-18AE81ED-E795-55BD-9796-41AAFA43D021"><a name="GUID-18AE81ED-E795-55BD-9796-41AAFA43D021"><!-- --></a><p>Resend a message
if an error occurs while sending. </p> </li>
</ul> <p>An SMS service can have configuration settings which control
the scheduled sending of messages. These configuration settings are
in four parts: </p> <ul>
<li id="GUID-FE65B7D1-C834-5F38-B766-4CFAA79152AB"><a name="GUID-FE65B7D1-C834-5F38-B766-4CFAA79152AB"><!-- --></a><p>General settings: <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html"><code class="apiname">CMsvScheduleSettings</code></a> </p> </li>
<li id="GUID-2E2F2C04-41F4-587D-A222-DFBDC5903AB0"><a name="GUID-2E2F2C04-41F4-587D-A222-DFBDC5903AB0"><!-- --></a><p>Off-peak times
settings: <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-E58A2F58-AF45-3D97-ACA6-6548FE507C3D.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-E58A2F58-AF45-3D97-ACA6-6548FE507C3D.html"><code class="apiname">CMsvOffPeakTimes</code></a>, which contains <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-0FAB21AD-16D5-34F4-A8E4-6A75EA02566E.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-0FAB21AD-16D5-34F4-A8E4-6A75EA02566E.html"><code class="apiname">TMsvOffPeakTime</code></a> objects </p> </li>
<li id="GUID-EC741167-6EBD-5E1C-956B-CE1AE755CB67"><a name="GUID-EC741167-6EBD-5E1C-956B-CE1AE755CB67"><!-- --></a><p>Send error actions
settings: <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-BF841328-372B-3F68-8BC9-5CB8639650D0.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-BF841328-372B-3F68-8BC9-5CB8639650D0.html"><code class="apiname">CMsvSendErrorActions</code></a>, which contains <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-4F039FEB-4821-3871-A5CF-0D453BF91EAD.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-4F039FEB-4821-3871-A5CF-0D453BF91EAD.html"><code class="apiname">TMsvSendErrorAction</code></a> objects </p> </li>
<li id="GUID-1E957A78-1369-5DAE-9AAD-8A833AC1AA1A"><a name="GUID-1E957A78-1369-5DAE-9AAD-8A833AC1AA1A"><!-- --></a><p>System agent
actions settings: <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-95828565-7389-381C-BD7E-B7F7B98A2487.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-95828565-7389-381C-BD7E-B7F7B98A2487.html"><code class="apiname">CMsvSysAgentActions</code></a>, which contains <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-322332B3-5259-3D51-A9AF-CFA2CD5617B6.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-322332B3-5259-3D51-A9AF-CFA2CD5617B6.html"><code class="apiname">TMsvSysAgentConditionAction</code></a> objects </p> </li>
</ul> <p>The above settings can be initialised and edited by a client
application using the following member functions of CSmsAccount: </p> <ul>
<li id="GUID-C724F70C-3299-57DB-9152-5059F398FDC1"><a name="GUID-C724F70C-3299-57DB-9152-5059F398FDC1"><!-- --></a><pre class="codeblock">void InitialiseDefaultSettingsL( CMsvScheduleSettings&amp; aScheduleSettings,
                                    CMsvOffPeakTimes&amp; aOffPeakTimes,
                                    CMsvSendErrorActions&amp; aErrorActions,
                                    CMsvSysAgentActions&amp;  aSysAgentActions ); </pre> </li>
<li id="GUID-B220B17C-DBEF-56FF-8AC5-A9B760E27660"><a name="GUID-B220B17C-DBEF-56FF-8AC5-A9B760E27660"><!-- --></a><pre class="codeblock">void LoadSettingsL( CMsvScheduleSettings&amp; aScheduleSettings,
                       CMsvOffPeakTimes&amp; aOffPeakTimes,
                       CMsvSendErrorActions&amp; aErrorActions,
                       MsvSysAgentActions&amp; aSysAgentActions );</pre> </li>
<li id="GUID-9993E309-541D-58A9-9556-E767848533D3"><a name="GUID-9993E309-541D-58A9-9556-E767848533D3"><!-- --></a><pre class="codeblock">void SaveSettingsL(const CMsvScheduleSettings&amp; aScheduleSettings,
                       const CMsvOffPeakTimes&amp; aOffPeakTimes,
                       const CMsvSendErrorActions&amp; aErrorActions,
                       const CMsvSysAgentActions&amp; aSysAgentActions ) const; 
             </pre> </li>
</ul> </div>
<div id="GUID-71736825-D78E-4452-B711-47C6A42CC343"><h3 class="section-title">Procedure</h3> <ol id="GUID-8AE541F3-1B0A-5D1D-AA3E-9D56B9513B38">
<li id="GUID-73A15840-8DC6-5EEE-BCCD-36AE86BC30EC"><a name="GUID-73A15840-8DC6-5EEE-BCCD-36AE86BC30EC"><!-- --></a><p>Create an SMS
account using the CSmsAccount::NewL() function. </p> </li>
<li id="GUID-9E5F5C1B-D4A3-5A5F-A351-FBDC34CC8F9C"><a name="GUID-9E5F5C1B-D4A3-5A5F-A351-FBDC34CC8F9C"><!-- --></a><p>Create an object
of CSmsSettings (SMS service) and set it with appropriate
settings as per your requirement. </p> <p><strong>Note</strong>: For
instructions on creating an SMS account and using the settings APIs,
see <a href="GUID-33B590F4-CAE8-58B2-92A9-53123BD42579.html">SMS Tutorial</a>.</p></li>
<li id="GUID-5125AF39-9039-5257-9260-579ADAEF7AFC"><a name="GUID-5125AF39-9039-5257-9260-579ADAEF7AFC"><!-- --></a><p>Create an instance
of <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html"><code class="apiname">CMsvScheduleSettings</code></a> to specify general settings
for sending a message. </p> </li>
<li id="GUID-01448B12-C1A7-5E5E-8991-2095363AF338"><a name="GUID-01448B12-C1A7-5E5E-8991-2095363AF338"><!-- --></a><p>Load the schedule
send settings using the LoadSettingsL() function. </p> </li>
<li id="GUID-BF412FB6-DF4A-5EE9-9BED-5C95FFFD84F8"><a name="GUID-BF412FB6-DF4A-5EE9-9BED-5C95FFFD84F8"><!-- --></a><p>Save the settings
using the SaveSettingsL() function. </p> <div class="p"><pre class="codeblock">
// See SMS tutorial for detailed instructions on the initial set up of SMS, such as message server session,
// MTM, SMS account and SMS message

    // Create objects for schedule send settings

    CMsvScheduleSettings* scheduleSettings = CMsvScheduleSettings::NewLC();
    TTimeIntervalSeconds interval(5);
    scheduleSettings-&gt;SetShortInterval(interval);

    // Load the schedule send settings
    smsAccount-&gt;LoadSettingsL(*scheduleSettings, *offPeakTimes);

    // save the settings 
    CSmsAccount *smsAccount = CSmsAccount::NewLC();
    smsAccount-&gt;SaveSettingsL( *scheduleSettings, *offPeakTimes);
    CleanupStack::PopAndDestroy(); // scheduleSettings, smsAccount</pre> </div> </li>
<li id="GUID-47E51360-87FF-5742-A08F-9653B34BF2B8"><a name="GUID-47E51360-87FF-5742-A08F-9653B34BF2B8"><!-- --></a><p>Create an SMS
message and set SetSendingState() and SetScheduled(). </p> <div class="p"><pre class="codeblock">
    //Create an SMS message (set up index entry)
    TMsvEntry newEntry;
    newEntry.iType = KUidMsvMessageEntry;
    newEntry.iServiceId = KMsvLocalServiceIndexEntryId;
    newEntry.iMtm = KUidMsgTypeSMS;
    newEntry.SetVisible(EFalse);
    newEntry.SetInPreparation(ETrue);
    newEntry.SetSendingState(KMsvSendStateWaiting);
    newEntry.SetScheduled(ETrue);</pre> </div> </li>
<li id="GUID-3594C62C-099C-53AE-A9FE-E6F57D7DD3E6"><a name="GUID-3594C62C-099C-53AE-A9FE-E6F57D7DD3E6"><!-- --></a><p>Send the message
at a specified time. </p> <p>To set a message to be sent at a specified
time: </p> <ol type="a" id="GUID-B030C1F9-6779-5244-9FDC-611D0F4A8A5E">
<li id="GUID-4B74937C-8A41-5024-9508-2806245FA2FC"><a name="GUID-4B74937C-8A41-5024-9508-2806245FA2FC"><!-- --></a><p>Update the time
to send, using <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-5A23B804-2C06-3407-9D48-1BFB212D699F.html#GUID-F60F7920-792C-3E53-870F-FC5BFFF84C73"><code class="apiname">TMsvEntry::iDate</code></a>, with the scheduled
time. </p> </li>
<li id="GUID-132F5600-986B-5AE8-A1E1-8F99D646FEEB"><a name="GUID-132F5600-986B-5AE8-A1E1-8F99D646FEEB"><!-- --></a><p>Create a selection
of messages to be sent using <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-6BC8851B-D913-3CE5-B343-5163661E8AD5.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-6BC8851B-D913-3CE5-B343-5163661E8AD5.html"><code class="apiname">CMsvEntrySelection</code></a>. </p> <p> Note: Every message in the selection must have the same
scheduled time. </p> </li>
<li id="GUID-E725D40B-2806-5D5F-8A5C-49E9AF9281DC"><a name="GUID-E725D40B-2806-5D5F-8A5C-49E9AF9281DC"><!-- --></a><p>Add the message
to the selection. </p> </li>
<li id="GUID-A9AA2EA7-6F52-53CF-8482-1C7E02C88118"><a name="GUID-A9AA2EA7-6F52-53CF-8482-1C7E02C88118"><!-- --></a><p>Call CSmsClientMtm::InvokeAsyncFunctionL() with command ID <code class="codeph">ESmsMtmCommandScheduleCopy</code>. </p> </li>
</ol> <p>The following code snippet schedules a message to be sent
in on day’s time: </p> <div class="p"><pre class="codeblock">CMsvEntrySelection* smsEntries = new (ELeave) CMsvEntrySelection;
CleanupStack::PushL(smsEntries);
TMsvId entryId;
entryId=newEntry-&gt;Id();

// Set the scheduled time for tomorrow
TTime t;
t.HomeTime();
t += TTimeIntervalDays(1);
newEntry.iDate=t;// update the time to send in the message (TMvsEntry) itself.

// Create a selection of messages to send
CMsvEntrySelection* smsEntries = new (ELeave) CMsvEntrySelection;
CleanupStack::PushL(smsEntries);

// Add the newly scheduled message to the selection
smsEntries-&gt;AppendL( newEntry-&gt;Id() );
TBuf8&lt;1&gt; p; 
CMsvOperation* op = iMtm-&gt;InvokeAsyncFunctionL(ESmsMtmCommandScheduleCopy,
*smsEntries, p, iStatus);
CleanupStack::PopAndDestroy(); //smsEntries
</pre> </div> </li>
</ol> <div class="note"><p><strong class="note_title">Note: </strong></p><ul>
<li><p>When the scheduled task occurs, not only will the selected
messages be sent but also any waiting SMS messages in the Outbox.</p></li>
<li><p>Messages successfully sent by the scheduled task are moved
to the Sent folder.</p></li>
</ul></div><p>Messages can be removed from the scheduler using the
asynchronous function ID <code class="codeph">ESmsMtmCommandDeleteSchedule</code>. </p><p><strong>Resend on errors or failed conditions</strong></p><p>A message
can be rescheduled at two stages of sending: </p><ul>
<li id="GUID-B3FC8C98-D165-5E7A-B2F5-9D42CDE2807E"><a name="GUID-B3FC8C98-D165-5E7A-B2F5-9D42CDE2807E"><!-- --></a><p>If send conditions
are not met (as seen above): The behaviour when this occurs is configured
as part of the send actions. </p> </li>
<li id="GUID-4154A12E-A6D8-5C90-BD0C-AF305BE63BA6"><a name="GUID-4154A12E-A6D8-5C90-BD0C-AF305BE63BA6"><!-- --></a><p>If sending to
any recipient fails: The behaviour in this event is determined by
a SEND_ERROR_ACTIONS resource in the SMS Server
MTM resource file (in the device ROM). The resource specifies the
actions that must be taken if errors occur. </p> </li>
</ul><p>Two additional factors can prevent rescheduling occurring: </p><ul>
<li id="GUID-6D141526-EB60-53B3-A734-1477CB4372D7"><a name="GUID-6D141526-EB60-53B3-A734-1477CB4372D7"><!-- --></a><p>In order to
avoid an infinite loop of attempting to send a message, which may
result in running the device battery down, a rescheduled message can
be limited to a maximum number of re-tries. If the maximum number
of re-tries is reached, then the message marked as failed and no further
retries are attempted. The maximum number of re-tries is defined in
the <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-95828565-7389-381C-BD7E-B7F7B98A2487.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-95828565-7389-381C-BD7E-B7F7B98A2487.html"><code class="apiname">CMsvSysAgentActions</code></a> error action. </p> </li>
<li id="GUID-9483768D-B2CA-5616-B789-B6519F5E6826"><a name="GUID-9483768D-B2CA-5616-B789-B6519F5E6826"><!-- --></a><p>A timeout can
be specified for waiting for sending conditions to occur. If the timeout
occurs before the conditions are met the pending SMS messages are
marked as failed. The timeout is configurable through the <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html#GUID-DF0D64F1-5408-335C-8FA8-FE5F874B97E4"><code class="apiname">CMsvScheduleSettings::SetPendingConditionsTimeout()</code></a> function.
The default is 0 (no timeout). The <a href="GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html#GUID-C6E5F800-0637-419E-8FE5-1EBB40E725AA/GUID-3A9254B7-77C2-300A-9128-6A7BD45F8CBA.html"><code class="apiname">CMsvScheduleSettings</code></a> is a separate stream in the SMS service entry store. </p> </li>
</ul></div>
<div id="GUID-045AC094-2508-4BD2-97A1-1B0DEF3DB232"><h3 class="section-title">See
also</h3> <p><a href="GUID-CF8FA653-5A3B-5D57-8875-0BC6BDCC1D0A.html">Schedule Send MTM Overview</a> </p> </div>
</div></div></div><div class="footer"><p class="metadata">Last updated January 31st, 2012</p><hr /><div class="copy">© Nokia 2012.</div></div></body>
<!-- Mirrored from devlib.symbian.slions.net/belle/GUID-AA978F65-C25B-59DC-82BC-6892228EA3F9.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 04:02:56 GMT -->
</html>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-4120651F-E0B9-5927-96B9-2662C51F5A09.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:16:08 GMT -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="copyright" content="(C) Copyright 2011" /><meta name="DC.rights.owner" content="(C) Copyright 2011" /><meta name="DC.Type" content="concept" /><meta name="DC.Title" content="SIP High Level API" /><meta name="DC.Relation" scheme="URI" content="GUID-32E29020-1956-461A-B79A-1492E06049E7" /><meta name="DC.Relation" scheme="URI" content="GUID-6425B722-4095-56E3-9198-70BA3E06C617" /><meta name="DC.Relation" scheme="URI" content="GUID-057F1F82-56AF-5696-853E-79196A3D567E" /><meta name="DC.Format" content="XHTML" /><meta name="DC.Identifier" content="GUID-4120651F-E0B9-5927-96B9-2662C51F5A09" /><meta name="DC.Language" content="en" /><title>SIP High Level API </title><link href="css/s60/style.css" rel="stylesheet" type="text/css" /><link href="PLUGINS_ROOT/com.nokia.forum.library/css/category_design.html" rel="stylesheet" type="text/css" /></head><body><div class="body"><div class="contentLeft prTxt"><h1 class="pageHeading" id="GUID-4120651F-E0B9-5927-96B9-2662C51F5A09">SIP High Level API</h1><div>
<p>The SIP High Level API encapsulates the SIP call flows inside the <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> APIs.
The following SIP functionality is supported using <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> APIs: </p>
<ul>
<li id="GUID-0A13EB92-CD3F-5F33-AE9F-3333BDFB5B03"><a name="GUID-0A13EB92-CD3F-5F33-AE9F-3333BDFB5B03"><!-- --></a><p>REGISTER - An
application that wants to start a SIP session must register to the
SIP server. For more information, see <a href="#GUID-02CBB3C7-9B7C-5B49-8F29-56F235FF320E">Registration</a>. </p> </li>
<li id="GUID-63D5BA93-28C1-5CE6-A1AD-78AD21EF5C6F"><a name="GUID-63D5BA93-28C1-5CE6-A1AD-78AD21EF5C6F"><!-- --></a><p>INVITE - An
invite session is created for activities such as setting up a voice
call, and a game session. For more information, see <a href="#GUID-EE044B0B-4664-57DA-BAE1-F9A3B99C453C">Session initiation</a>. </p> </li>
<li id="GUID-40206112-EC3B-57EF-B316-F7C938EB2118"><a name="GUID-40206112-EC3B-57EF-B316-F7C938EB2118"><!-- --></a><p>SUBSCRIBE -
SIP supports subscription to events for example, message waiting,
notifying the subscriber about the current state of the event and
any changes to its state. For more information, see <a href="#GUID-BF804D44-35A2-5997-9706-B48C2C30F2BE">Initiating a session using SUBSCRIBE</a>. </p> </li>
</ul>
<p>The <code class="codeph">INVITE</code> and <code class="codeph">SUBSCRIBE</code> methods
must be registered. CSubConSIPInviteParamSet and CSubConSIPSubscribeParamSet classes provide the parameters. </p>
<p> <strong>Note</strong>: SIP High Level API is included in the Symbian OS
v9.2 onwards. </p>
<div id="GUID-02CBB3C7-9B7C-5B49-8F29-56F235FF320E"><h3 class="section-title">Registration</h3> <p>An endpoint, for example a SIP enabled phone, that wants to start
a SIP session must use <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> to register
with the SIP registrar. For more information about RConnection, see <a href="GUID-BD8446C5-3ADE-59A6-A13A-A5482D6FC56F.html">Connection Management</a> . ESOCK provides an interface for the user to
access the SIP high level API. ESOCK interacts
with the SIP high level API through the <code class="codeph">Connection</code> and <code class="codeph">SubConnection</code> providers. Connection and SubConnection
providers are <code class="codeph">ESOCK</code> server side components that are
loaded and called when <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> APIs are used. </p> <p>The following figure
shows the architectural layer where the application interacts with
SIP connection providers using SIPPARAMS. The second layer comprising <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-D4F08503-F1EF-3531-9C3C-4AF24A6255F0.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-D4F08503-F1EF-3531-9C3C-4AF24A6255F0.html"><code class="apiname">RSocket</code></a>, <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a>, and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> constitute the SIPPARAMS. </p> <div class="figure" id="GUID-57FDC30F-E5AD-5C9D-8D80-71B35CB905D4"><img src="GUID-FFE6BAF8-C093-53FC-8672-365BAF38E048_d0e411308_href.png" /><p class="figure-title"><strong>Figure: </strong>              Interface of Connection and Sub Connection. 
          </p></div> <p>The SIP high level API models the SIP with Connection and
SubConnection providers and makes it stackable against the unified
comms-infras architecture. This enables the future connection convergence. </p> <p><strong> Initial setup</strong> </p> <p>A profile data store is required
to get registered with the SIP Registrar. A SIP registration profile
is a data store containing the information required for registration
such as AOR which is the IP address of registrar. The data profile
must contain the following fields: </p> <ul>
<li id="GUID-9419A4E2-40DB-52E4-9B70-89DEF5594CF6"><a name="GUID-9419A4E2-40DB-52E4-9B70-89DEF5594CF6"><!-- --></a><p>data profile
type: Internet, IMS, others </p> </li>
<li id="GUID-36207215-4ECE-5D08-AEFB-6D801DBA0902"><a name="GUID-36207215-4ECE-5D08-AEFB-6D801DBA0902"><!-- --></a><p>profile name
IETF, IMS, others </p> </li>
<li id="GUID-FF904FF9-9D4B-5B34-986F-8F565BDE8E41"><a name="GUID-FF904FF9-9D4B-5B34-986F-8F565BDE8E41"><!-- --></a><p>IAP name </p> </li>
<li id="GUID-C66C0664-B9A8-59C8-8C44-88634D7D2E94"><a name="GUID-C66C0664-B9A8-59C8-8C44-88634D7D2E94"><!-- --></a><p>profile AOR
list (IP address) </p> </li>
<li id="GUID-D85CF1F0-98CA-5947-90EB-0C4D0B96EBCC"><a name="GUID-D85CF1F0-98CA-5947-90EB-0C4D0B96EBCC"><!-- --></a><p>autoregistration </p> </li>
<li id="GUID-FC499704-39DC-55E1-80EC-3A3F8F0A8C53"><a name="GUID-FC499704-39DC-55E1-80EC-3A3F8F0A8C53"><!-- --></a><p>private ID </p> </li>
<li id="GUID-ED9C3D8E-A8CC-5D65-B381-81EC51264980"><a name="GUID-ED9C3D8E-A8CC-5D65-B381-81EC51264980"><!-- --></a><p>security negotiation </p> </li>
<li id="GUID-B400C58A-E180-54B7-A536-7B7103CD4274"><a name="GUID-B400C58A-E180-54B7-A536-7B7103CD4274"><!-- --></a><p>sigcomp </p> </li>
<li id="GUID-AB1D459F-CCEA-5D20-8FCE-02939F716093"><a name="GUID-AB1D459F-CCEA-5D20-8FCE-02939F716093"><!-- --></a><p>server (IP address
of registrar, outbound proxy) </p> </li>
<li id="GUID-999CAACE-4E8F-5EDA-877E-2A46580D9BA9"><a name="GUID-999CAACE-4E8F-5EDA-877E-2A46580D9BA9"><!-- --></a><p>server param
(username, realm, pwd) </p> </li>
<li id="GUID-B4AAE1EE-1A67-5FBE-8F75-9BCB01E2ECE2"><a name="GUID-B4AAE1EE-1A67-5FBE-8F75-9BCB01E2ECE2"><!-- --></a><p>default </p> </li>
</ul> <p>Manual registration by specifying parameters is not possible.
If connection details are not available, the connection is set up
using the default <code>profile.flag</code> file. </p> <p id="GUID-D17BC438-09C2-58E9-ABE8-F18B8A285B4D"><a name="GUID-D17BC438-09C2-58E9-ABE8-F18B8A285B4D"><!-- --></a><strong>Creating an RConnection</strong> </p> <p>Create an <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> to register to
the SIP Registrar using the following steps. <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> must be opened on an existing socket server session, <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-EF29C1D7-B1E5-370F-AE37-66231A6BE449.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-EF29C1D7-B1E5-370F-AE37-66231A6BE449.html"><code class="apiname">RSocketServ</code></a>. </p> <pre class="codeblock">RSocketServ    socketServer;        // Create a client interface object to the socket server
RConnection    con;                        // Create an RConnection object
TRequestStatus status = KErrNone;                // object to hold the request completion status

// Establish the connection to the Socket server

User::LeaveIfError(socketServer.Connect());        // Returns KErrorNone if the connection is successful
CleanupClosePushL(socketServer);

TUint KAFSip = 0x10000;             //SIP protocol family id
TInt err = con.Open (socketServer,KAFSip);            //open the connection
TInt err1 = con.Start();                    // Start Rconnection to initiate the registration
</pre> <p>When registration to the SIP registrar is successful, <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> is used to establish the SIP Invite or SIP
Subscribe session. The <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> that is established and opened are used
for either inviting a call session or subscribing for the message
status. </p> </div>
<div id="GUID-565742FA-20AB-57A8-AB81-19664F9B2BC8"><h3 class="section-title">Session
initiation</h3> <p><strong>SIP Params</strong> </p> <p>SIPPARAMS is used
to simplify the interaction with the SIP stack by abstracting the
SIP functionality using the <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> and <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> APIs.  It supports the basic SIP
functionality. The complete SIP functionality is made available through
the SIP stack APIs. </p> <p id="GUID-EE044B0B-4664-57DA-BAE1-F9A3B99C453C"><a name="GUID-EE044B0B-4664-57DA-BAE1-F9A3B99C453C"><!-- --></a><strong>Initiating a session
using INVITE</strong> </p> <p> <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> is used
to establish a SIP Invite session. A SIP invitation starts when an
endpoint such as a VoIP Softphone or VoIP Hardware tries to establish
a session with a remote compliant endpoint. A successful SIP invitation
consists of an INVITE-OK-ACK triplet message exchange. The calling
endpoint tries to start a session with SIP INVITE. This is followed
by OK from the called endpoint, and by ACK from the calling endpoint
that finally establishes the SIP session. </p> <p>A SIP session can
be terminated by using BYE-200OK message exchange. Either the calling
or the called party can initiate the termination. </p> <p> <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> establishes the SIP session using the three
way communication of INVITE-OK-ACK and terminates the call using BYE-200OK. </p> <p> <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> when used on behalf of the
calling endpoint, handles the message exchange independently and provides
the status whether the session is established, denied or not reachable.
The calling endpoint must fill the necessary SIP session parameters
that are used to determine the target. </p> <p> <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> when used on behalf of the called endpoint alerts the user of an
incoming call such as a SIP invitation. The incoming call can be either
accepted or rejected using <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a>. The
application is notified about the outcome. The information about the
calling endpoint is provided in a set of specific parameters. </p> <p>The SIP parameters for an outgoing call is set using CSubConSIPInviteParamSet class. The following code shows
how to initiate a call. It is assumed that you have already registered
with the SIP registrar by creating an <code class="codeph">RConnection</code> object and called <code class="codeph">Open()</code>. For more information,
see <a href="#GUID-D17BC438-09C2-58E9-ABE8-F18B8A285B4D">Creating an RConnection</a>. </p> <pre class="codeblock">RSubConnection    subCon;    // Create an RSubConnection object
err=subCon.Open(socketServer,RSubConnection::ECreateNew,con); // Open subconnection onto the Rconnection
</pre> <p>Set the SIP Invite parameters. The following code
shows how to set the SIP Invite parameters. </p> <pre class="codeblock">RSubConParameterBundle     sipBundle;            // create parameter bundle

// create SIP parameter set family
CSubConParameterFamily * family = CSubConParameterFamily::NewL(sipBundle,KSubConnCallDescrParamsFamily);

// create invite parameter set object
CSubConSIPInviteParamSet* sip = CSubConSIPInviteParamSet::NewL(*family,CSubConParameterFamily::ERequested);</pre> <p>Set the SIP header values to the parameter set. The following
code shows how to set the SIP header values to the parameter set. </p> <pre class="codeblock">_LIT8(KTo,"Sip:user@10.112.165.91");        //'To' header, SIP URI of called endpoint
TPtrC8 ptrTo(KTo());
sip-&gt;SetToL(ptrTo);         //Set'To', the target SIP URI to the SIP parameter set

_LIT8(KFrom, "Sip:user@10.112.165.62");        //'From' header, SIP URI of the calling endPoint
TPtrC8 ptrFrom(KFrom());
sip-&gt;SetFromL(ptrFrom);                //Set the 'From' header field to the SIP parameter set

_LIT8(KContact,"Sip:user@10.112.165.62");            //'Contact' header, the actual location of the calling endpoint
TPtrC8 ptrContact (KContact());
sip-&gt;SetContactL(ptrContact);                //Set the 'Contact' to the SIP parameter set 

_LIT8(KRequestUri, "Sip:user@10.112.165.91");    //Request URI, the actual Next hop or the Target
TPtrC8 ptrRequestUri(KRequestUri());
sip-&gt;SetRequestUriL(ptrRequestUri);             //Set the 'RequestUri' to the SIP parameter set</pre> <pre class="codeblock">TInt err = SubCon.SetParameters(sipBundle);         //Set The SIP parameters in the SubConnection
sipBundle.Close();                    //close the parameter bundle</pre> <p id="GUID-8676EB5B-FA5D-51EC-9FAD-C36BB29A6392"><a name="GUID-8676EB5B-FA5D-51EC-9FAD-C36BB29A6392"><!-- --></a><strong>Establishing
the INVITE session</strong> </p> <p>To establish the SIP Invite session,
use <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> to start the subconnection.
This initiates the Invite request. </p> <pre class="codeblock">//Start the subconnection, effectively sending an Invite
TInt subConRet = subCon.Start(); 
// Session is established</pre> <p id="GUID-BF804D44-35A2-5997-9706-B48C2C30F2BE"><a name="GUID-BF804D44-35A2-5997-9706-B48C2C30F2BE"><!-- --></a><strong>Initiating a session
using SUBSCRIBE</strong> </p> <p>An endpoint subscribes to a specific service
using a SIP SUBSCRIBE-200OK message exchange. The end point is notified
by means of a NOTIFY-200OK message exchange. To send the subscription
and receive notifications use <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a>. <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> is also used to unsubscribe, which stops
any further notifications. </p> <p>The following code shows how you
subscribe to a session and receive notifications. It assumes that
you have already registered with the SIP registrar by creating an <code class="codeph">RConnection</code> object and calling <code class="codeph">Open()</code> on
it as explained in <a href="#GUID-D17BC438-09C2-58E9-ABE8-F18B8A285B4D">Creating an RConnection</a> section. </p> <pre class="codeblock">RSubConnection    subCon;// Create an RSubConnection object
// Open subconnection onto the Rconnection
err=subCon.Open(socketServer,RSubConnection::ECreateNew,con);
</pre> <p>Set the SIP Subscribe parameters using CSubConSIPSubscribeParamSet. This class provides the SIP subscribe parameters that are passed
through the subconnection to the SIP stack. </p> <pre class="codeblock">RSubConParameterBundle     sipBundle;                 //    create parameter bundle

//create SIP parameter set family
CSubConParameterFamily * family = CSubConParameterFamily::NewL(sipBundle,KSubConnCallDescrParamsFamily);

// create subscribe parameter set object
CSubConSIPSubscribeParamSet* sip = CSubConSIPSubscribeParamSet::NewL(*family,CSubConParameterFamily::ERequested);</pre> <p>Set <code class="codeph">the required information that is, to</code>, <code class="codeph">from</code>, <code class="codeph">contact,</code> and <code class="codeph">reqURI</code> header values to the SIP subscribe parameter set as explained in <a href="#GUID-EE044B0B-4664-57DA-BAE1-F9A3B99C453C">Initiating a session using INVITE</a> section. </p> <pre class="codeblock">// Set the required information
_LIT8(KEventType, "messagewaiting");    // subscription event type
TPtrC8 ptrEventType (KEventType());
sip-&gt;SetEventTypeL(ptrEventType);     //Set the subscription event type to 'messagewaiting'

_LIT8(KAcceptType,  "application");    //accept type
TPtrC8 ptrAcceptType(KAcceptType());
sip-&gt;SetAcceptTypeL(ptrAcceptType); //set the accept type field to 'application'

_LIT8(KAcceptSubType,   "indication"); //accept subtype
TPtrC8 ptrAcceptSubType(KAcceptSubType());
sip-&gt;SetAcceptSubTypeL(ptrAcceptSubType);    //set the accept subtype

sip-&gt;SetExpires(3600);    // set the subscription Refresh timings

sip-&gt;SetAutoRefresh(ETrue); // set Auto Refresh to 'on' 

// pass SIP subscribe parameters through the subconnection
Tint err = subCon.SetParameters(sipBundle);
sipBundle.Close(); //close the parameter bundle

subCon.Start();    // Start the subscription
</pre> <p>To receive notifications to the subscribed events, CSubConSIPNotificationEvent class is used. </p> <pre class="codeblock">// Wait and receive notifications to events
while(ETrue)
{
TNotificationEventBuf evtBuf;         // Sub-connection event notification object

    TRequestStatus reqStatus;             // request status object

    User::WaitForRequest(reqStatus);
    TInt eventId = evtBuf.Id();                     // get sub-type id
    TInt groupId = evtBuf.GroupId();         // get group id of the event

if (eventId == KSubConSIPNotificationEventType &amp;&amp; groupId == KSubConSIPEventsUid)
        {
                CSubConSIPNotificationEvent * evtRes = (CSubConSIPNotificationEvent*)CSubConNotificationEvent::NewL(evtBuf);
                CleanupStack::PushL(evtRes);    
                ....................
                ....................
                CleanupStack::PopAndDestroy(evtRes);    

            // Since We do not want to receive more notifications in this stage, break from the loop.

                break;
        }

// we can wait again for another notification
subCon.EventNotification( evtBuf,EFalse, reqStatus);  //request for notification
}</pre> <p>Unsubscribe to events and unregister, refer to steps
in the <a href="#GUID-FB267A38-FFB3-5360-9DC8-3E42C5C546A4">Terminating the session</a> section. </p> <p><strong>Setting authentication
parameters</strong> </p> <p>A remote party or a server may require authentication
before it allows an endpoint to establish a session with another endpoint. <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> provides an authentication mechanism where
the authentication information such as realm, username and password
must be provided while initiating the call. If a challenge is received
then <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> provides the realm and initiates
a new session with authentication parameters. </p> <p>Authentication
parameters are set in a subconnection parameter bundle as shown in
the following code fragment. Set the SIP authenticate parameter set
using CSubConSIPAuthenticateParamSet. This class
provides the SIP authenticate parameter values that are passed through
the subconnection to the SIP stack. </p> <pre class="codeblock">RSubConParameterBundle     sipBundle;                         //    create parameter bundle
// Add authorisation parameters as new family
CSubConParameterFamily * family1 = CSubConParameterFamily::NewL(sipBundle,KSubConAuthorisationFamily );

// create authenticate parameter set object
CSubConSIPAuthenticateParamSet * authParam = CSubConSIPAuthenticateParamSet::NewL(*family1,CSubConParameterFamily::ERequested);
</pre> <p>Set <code class="codeph">the required information that is, to</code>, <code class="codeph">from</code>, <code class="codeph">contact</code>, <code class="codeph">reqURI</code> header field values to the SIP authenticate parameter set, similar
to that in <a href="#GUID-EE044B0B-4664-57DA-BAE1-F9A3B99C453C">Initiating a session using INVITE</a> section. </p> <pre class="codeblock">_LIT8(KRealm, "SFTF");
_LIT8(KUserName, "MyUserName");
_LIT8(KPwd, "pass123");

authParam-&gt;SetRealmL(KRealm);    //set the Realm parameter
authParam-&gt;SetUserNameL(KUserName);    // set the username
authParam-&gt;SetPasswordL(KPwd);                    //set the password

TInt err = subCon.SetParameters(sipBundle); //set the Authenticate parameters to the subconnection
sipBundle.Close();                    //close the parameter bundle</pre> <p>To terminate the call session or unsubscribe to events and unregister,
follow the steps in <a href="#GUID-FB267A38-FFB3-5360-9DC8-3E42C5C546A4">Terminating the session</a> section. </p> </div>
<div id="GUID-FB267A38-FFB3-5360-9DC8-3E42C5C546A4"><h3 class="section-title">Terminating
the session</h3> <p>To terminate the SIP INVITE or SUBSCRIBE session: </p> <ul>
<li id="GUID-E1DABB93-F761-554F-82F9-78CAF0116A2C"><a name="GUID-E1DABB93-F761-554F-82F9-78CAF0116A2C"><!-- --></a><p>send BYE message
by closing the <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-0AFDA357-EE44-3788-9CAB-162B874134BF.html"><code class="apiname">RSubConnection</code></a> session </p> </li>
<li id="GUID-D8757702-DB58-5F75-A00A-9251B3975CFF"><a name="GUID-D8757702-DB58-5F75-A00A-9251B3975CFF"><!-- --></a><p>unregister with
the SIP registrar by closing the <a href="GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html#GUID-251A35C1-CC66-4DE4-9EBE-964026E89E7F/GUID-BED8A733-2ED7-31AD-A911-C1F4707C67FD.html"><code class="apiname">RConnection</code></a> session. </p> </li>
</ul> <pre class="codeblock">Int ret = subCon.Stop();    // Terminate the session, send BYE message

subCon.Close();        // close the subconnection

con.Stop();      // Terminate the connection

con.Close();        // Close the connection </pre> </div>
<div id="GUID-B6F7F947-1E4B-4DFD-80B4-70E5E890685A"><h3 class="section-title">See
also</h3> <p> <a href="GUID-1277D793-4A0A-50A7-9414-AEE93E906E80.html">Socket Server Architecture</a> </p> <p> <a href="GUID-56DF9711-1EFA-5A07-A92B-3F3D6FBD17A8.html">Sockets Server Client
API</a> </p> <p><a href="GUID-BD8446C5-3ADE-59A6-A13A-A5482D6FC56F.html">Connection Management</a></p> </div>
</div></div></div><div class="footer"><p class="metadata">Last updated November 16th, 2010</p><hr /><div class="copy">© Nokia 2011.</div></div></body>
<!-- Mirrored from devlib.symbian.slions.net/s3/GUID-4120651F-E0B9-5927-96B9-2662C51F5A09.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 27 Mar 2020 06:16:15 GMT -->
</html>